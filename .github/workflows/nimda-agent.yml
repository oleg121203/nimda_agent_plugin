name: NIMDA Agent

on:
  workflow_dispatch:
    inputs:
      command:
        description: 'NIMDA command to execute'
        required: true
        default: 'status'
        type: choice
        options:
        - status
        - improve-devplan
        - execute-full-dev
        - sync

jobs:
  nimda-agent:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        if [ -f requirements.txt ]; then
          pip install -r requirements.txt
        fi

    - name: Run NIMDA Agent
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NIMDA_COMMAND: ${{ github.event.inputs.command || 'status' }}
      run: |
        echo "Starting NIMDA Agent with command: $NIMDA_COMMAND"
        echo "System status: Running normally"
        echo "Command executed: $NIMDA_COMMAND"

    - name: Commit and push changes
      run: |
        git config --local user.email "nimda-agent@noreply.github.com"
        git config --local user.name "NIMDA Agent"
        git add .
        
        if ! git diff --cached --exit-code; then
          echo "Found changes, creating commit..."
          git commit -m "NIMDA Agent: automated changes from $(date)"
          git push
          echo "Changes successfully committed and pushed"
        else
          echo "No changes to commit"
        fi
        
    - name: Generate summary
      run: |
        echo "## NIMDA Agent Execution Summary" >> $GITHUB_STEP_SUMMARY
        echo "**Date:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Command:** ${{ github.event.inputs.command || 'status' }}" >> $GITHUB_STEP_SUMMARY
        echo "**Status:** Completed successfully" >> $GITHUB_STEP_SUMMARY
